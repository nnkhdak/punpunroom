<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<base href="../">
	<link rel="stylesheet" type="text/css" href="assets/style.css" />
	<style>
		/* 画面毎設定 */
		.width1 {
			width: 100px;
		}

		.width2 {
			width: 150px;
		}

		code {
			display: block;
			white-space: pre;
		}

		main ol li {
			margin-top: 1em;
		}
	</style>
</head>

<body>
	<noscript>
		<p>JavaScriptがサポートされていないため表示できません。</p>
	</noscript>
	<header></header>
	<main style="display: none;">
		<div id="mainLeft"></div>
		<div id="mainCenter">
			<h2>Oracle</h2>
			<ul>
				<li>
					<details open>
						<summary>10秒以上のスロークエリ</summary>
						<code>SELECT DISTINCT
	s.sid
,	s.SERIAL#
,	s.status
,	s.program
,	q.module
,	q.sql_id
,	dbms_lob.substr(q.sql_fulltext, 3000, 1)	AS sql
,	s.last_call_et								AS 実行時間
,	q.parsing_schema_name
,	q.first_load_time
,	q.last_load_time
,	s.osuser
,	s.machine
FROM
	v$session s
,	v$sql     q
WHERE
	s.sql_id = q.sql_id AND s.last_call_et > 10</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>通算秒(エポック秒)</summary>
						<code>select (<i>調べたいdate</i> - to_date('19700101', 'YYYYMMDD')) * 24 * 60 * 60 from dual</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>自分のテーブルにMERGE</summary>
						<code>MERGE INTO <i>テーブル名</i> USING dual
ON <strong>(</strong><i>項目</i> = <i>値</i><strong>)</strong>
WHEN MATCHED THEN UPDATE SET
	項目1</i> = <i>値1</i>
,	項目2</i> = <i>値2</i>
WHEN NOT MATCHED THEN INSERT (
	<i>項目1</i>
,	<i>項目2</i>
) VALUES (
	<i>値1</i>
,	<i>値2</i>
)</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>Select結果を使ってUPDATE(Mergeを使う)</summary>
						<code>MERGE INTO
	更新したいテーブル名 t0
USING (
	SELECT
		  取得する項目1
		, 取得する項目2
	FROM
		テーブル１ t1
		JOIN テーブル２	t2 ON 結合条件
	WHERE
		検索条件(1行になるように)
	) tmp
ON (
	更新したい条件
)
WHEN MATCHED THEN UPDATE
SET
	  更新する項目1 = 取得する項目1
	, 更新する項目2 = 取得する項目2</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>まとめて複数INSERTを書く</summary>
						<code>INSERT ALL
INTO <i><strong>table_name</strong></i> (<i><strong>項目１</strong></i>,<i><strong>項目２</strong></i>) VALUES (<i><strong>値１</strong></i>,<i><strong>値２</strong></i>)
INTO <i><strong>table_name</strong></i> (<i><strong>項目１</strong></i>,<i><strong>項目２</strong></i>) VALUES (<i><strong>値１</strong></i>,<i><strong>値２</strong></i>)
INTO <i><strong>table_name</strong></i> (<i><strong>項目１</strong></i>,<i><strong>項目２</strong></i>) VALUES (<i><strong>値１</strong></i>,<i><strong>値２</strong></i>)
SELECT * FROM DUAL;</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>カンマ区切りを行にする</summary>
						<code>SELECT
	regexp_substr(t1.nums, '[^,]+', 1, t2.arr_num) AS val
,	t2.arr_num									   AS seq
FROM (
	SELECT
		'001,002,003' nums
	FROM
		dual
) t1
,	LATERAL (
	SELECT
		level AS arr_num
	FROM
		dual
	CONNECT BY
		instr(t1.nums, ',', 1, level - 1) > 0
) t2</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>日付フォーマット</summary>
						<code>TO_CHAR(CURRENT_DATE, 'YYYY/MM/DD HH24:MI:SS')</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>テーブル構造が同じテーブルを作成＆データのコピー</summary>
						<code>CREATE TABLE <i><strong>新table_name</strong></i> AS SELECT * FROM <i><strong>旧table_name</strong></i></code>
					</details>
				</li>
				<li>
					<details open>
						<summary>テーブルの完全削除</summary>
						<code>DROP TABLE <i><strong>table_name</strong></i> CASCADE CONSTRAINTS PURGE;</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>?件数の架空のテーブルをSELECT</summary>
						<code>SELECT <strong>LEVEL</strong> AS lv FROM DUAL <strong>CONNECT BY LEVEL</strong> &lt;= 3;</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>テーブル名を表示</summary>
						<code>SELECT <strong>table_name</strong> FROM all_tables ORDER BY <strong>table_name</strong>;</code>
						<code>SELECT <strong>table_name</strong> FROM user_tables ORDER BY <strong>table_name</strong>;</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>テーブル構造を表示</summary>
						<code>DESC <i><strong>table_name</strong></i>;</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>シノニムを表示</summary>
						<code>SELECT * FROM all_synonyms;</code>
						<code>SELECT * FROM user_synonyms;</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>sqlplusで接続</summary>
						<code>sqlplus <i>ユーザ名</i>@<i>サーバ名</i></code>
						<code>sqlplus <i>ユーザ名</i>@<i><strong>net_service_name</strong></i></code>
					</details>
				</li>
				<li>
					<details open>
						<summary>tnsnames.ora</summary>
						<code><i><strong>net_service_name</strong></i> =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = myserver.mycompany.com)(PORT = 1521))
(CONNECT_DATA =
  (SERVER = DEDICATED)
  (SERVICE_NAME = orcl)
)
)</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>tnsnames.oraに複数回定義する</summary>
						<code><i><strong>net_service_name1</strong></i> =
(DESCRIPTION = ......)
<i><strong>net_service_name2</strong></i> =
(DESCRIPTION = ......)</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>折り返し行？を設定</summary>
						<code>SET LINE <i>行数</i>;</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>SQL Developer</summary>
						<code>メニューバー ＞ ツール ＞ プリファレンスを選択
プリファレンスダイアログ　＞　データベース　＞　オブジェクト・ビューアを選択
「データベース：オブジェクト・ビューア」　＞　「オブジェクト・ビューア・ウィンドウの自動固定」にチェックを入れる</code>
						<code>メニューバー ＞ ツール ＞ プリファレンスを選択
プリファレンスダイアログ　＞　データベース　＞　オブジェクト・ビューアを選択
「データベース：オブジェクト・ビューア」　＞　「シングル・クリックでオブジェクトをオープン」のチェックをはずす</code>
					</details>
				</li>
				<li>
					<details open>
						<summary>AmazonLinux2にインストールし設定</summary>
						/etc/environmentに以下を追記
						<code>LANG=ja_JP.UTF-8
NLS_LANG=Japanese_Japan.AL32UTF8
ENVIRONMENT=development<strong> &lt;- これは違う目的</strong></code>
						<br />
						/etc/profile.d/oracle.shを作成(ココに配置することで/etc/profileに記述したときと同じ扱い)
						<code>export NLS_LANG=Japanese_Japan.AL32UTF8
export LD_LIBRARY_PATH=/opt/oracle/instantclient_19_6
export PATH=$PATH:$LD_LIBRARY_PATH</code>
						<br />
						systemctl edit
						httpd.service(コレで保存すると/etc/systemd/system/httpd.service.d/override.confに保存したときと同じ扱い)
						<code>[Service]
EnvironmentFile=/etc/environment</code>
					</details>
				</li>
			</ul>
		</div>
		<div id="mainRight"></div>
	</main>
	<footer></footer>
</body>
<script src="assets/script.js"></script>

</html>